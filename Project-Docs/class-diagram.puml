@startuml
hide circle
skinparam classAttributeIconSize 0

' =========================
' ENUMS
' =========================
enum TipoItemRevisao {
  Peca
  Servico
}

' Mantido: hoje é usado diretamente em Moto.Modelo e em filtros/buscas.
enum ModeloMoto {
  MT03
  NMAX
  XMAX
  FAZER_250
  ' (lista completa pode ser mantida fora do diagrama)
}

enum StatusRevisao {
  Pendente
  Agendada
  Executada
  Cancelada
}

' =========================
' AUTENTICAÇÃO
' =========================
class Usuario <<Model>> {
  +Email : string
  +SenhaHash : string
  +Ativo : bool

  --
  +AlterarSenha(novaSenha : string) : void
  +Desativar() : void
}

class AuthService <<Service>> {
  +CadastrarCliente(email : string, senha : string, cpf : string, nome : string) : Cliente
  +CadastrarConcessionaria(email : string, senha : string, cnpj : string, nome : string) : Concessionaria
  +Autenticar(email : string, senha : string) : Usuario
}

' =========================
' DOMÍNIO (MODELS)
' =========================
class Cliente <<Model>> {
  +Id : int
  +NomeProprietario : string
  +CPF : string
  +Email : string
  +Tel : string
  +Cel : string
  +Endereco : Endereco?
  +Motos : List<Moto>
}

class Concessionaria <<Model>> {
  +Id : int
  +NomeConcessionaria : string
  +CNPJ : string
  +Tel : string
  +Enderecos : List<Endereco>
  +Clientes : List<Cliente>
  +ChecklistTemplates : List<ChecklistTemplate>
}

class Endereco <<Model>> {
  +Id : int
  +CEP : string
  +Rua : string
  +Numero : int
  +Bairro : string
  +Complemento : string

  --
  +Formatar() : string
  +DistanciaAte(outro : Endereco) : double
}

class Moto <<Model>> {
  +Id : int
  +Modelo : ModeloMoto
  +Placa : string
  +COR : string
  +NumeroChassi : string
  +DataDeVenda : DateTime
  +NotaFiscal : string
  +Serie : int
  +ImgDecalqueChassi : string
  +Revisoes : List<Revisao>

  --
  +ObterUltimaRevisaoExecutada() : Revisao?
  +ObterRevisao(numero : int) : Revisao?
}

class Revisao <<Model>> {
  +Id : int
  +Numero : int
  +Status : StatusRevisao

  +Cliente : Cliente
  +Moto : Moto
  +ConcessionariaResponsavel : Concessionaria?

  +DataAgendada : DateTime?
  +DataExecucao : DateTime?
  +KMAtual : int?

  +Itens : List<RevisaoItem>
  +ValorTotal : decimal
  +NotaDeServico : string

  --
  +Agendar(data : DateTime, concessionaria : Concessionaria) : void
  +Reagendar(novaData : DateTime) : void
  +Cancelar(motivo : string) : void
  +GerarNotaDeServico() : string
  +RegistrarExecucao(itensRealizados : List<RevisaoItem>, valorTotal : decimal, notaDeServico : string, dataExecucao : DateTime, kmAtual : int) : void
  +ItensNaoExecutados(template : ChecklistTemplate) : List<ItemTemplate>
}

class RevisaoItem <<Model>> {
  +Tipo : TipoItemRevisao
  +Descricao : string
  +Grupo : string?
  +Ordem : int
  +Valor : decimal?
  +Quantidade : decimal?
  +Realizado : bool

  --
  +Subtotal() : decimal
}

' =========================
' CHECKLIST (VARIA POR MODELO)
' Alterações SOMENTE aqui:
' - Catálogo de itens para não repetir peça/serviço
' - ChecklistTemplate aplica em múltiplos modelos
' - ItemTemplate referencia catálogo (ItemCatalogoId)
' =========================

' NOVA classe (faltando) para eliminar repetição de peças/serviços
class ItemCatalogo <<Model>> {
  +Id : int
  +Tipo : TipoItemRevisao
  +Descricao : string
}

class ChecklistTemplate <<Model>> {
  +Id : int
  +NumeroRevisao : int
  +Modelos : List<ModeloMoto>
  +Itens : List<ItemTemplate>

  --
  +AdicionarItem(item : ItemTemplate) : void
  +RemoverItem(ordem : int) : void

  ' Mantido (nome igual). Implementação pode delegar p/ Service.
  +GerarItensParaRevisao() : List<RevisaoItem>

  ' NOVO overload (pra suportar catálogo sem acoplar o Model a Provider)
  +GerarItensParaRevisao(itensCatalogo : List<ItemCatalogo>) : List<RevisaoItem>
}

class ItemTemplate <<Model>> {
  +Id : int
  +ItemCatalogoId : int
  +Grupo : string?
  +Ordem : int
  +ValorSugerido : decimal?

  --
  ' Mantido
  +ParaRevisaoItem() : RevisaoItem

  ' NOVO overload (usa o catálogo para preencher Tipo/Descricao)
  +ParaRevisaoItem(itemCatalogo : ItemCatalogo) : RevisaoItem
}

' =========================
' CONFIGURAÇÃO GLOBAL (BANCO)
' =========================
class ConfiguracaoAgendamento <<Model>> {
  +KmToleranciaPercent : double
  +TempoToleranciaDias : int
  +AtualizadoEm : DateTime

  --
  +Atualizar(kmToleranciaPercent : double, tempoToleranciaDias : int) : void
}

class AlertaRevisao <<Model>> {
  +PlacaMoto : string
  +NumeroRevisao : int
  +Mensagem : string
  +EmAtraso : bool
}

' =========================
' REGRAS FIXAS (JSON)
' =========================
class RegraRevisao <<Model>> {
  +NumeroRevisao : int
  +KmAlvo : int
  +MesesAlvo : int
}

class RegraRevisaoProvider <<Provider>> {
  +Carregar() : void
  +Obter(numeroRevisao : int) : RegraRevisao
  +Listar() : List<RegraRevisao>
}

' NOVO provider (carrega catálogo de peças/serviços)
class ItemCatalogoProvider <<Provider>> {
  +Carregar() : void
  +Obter(id : int) : ItemCatalogo
  +Listar() : List<ItemCatalogo>
}

' =========================
' SERVIÇOS (MVC/Application Services)
' =========================
class ClienteService <<Service>> {
  +AtualizarContato(tel : string, cel : string, email : string) : void
  +CadastrarMoto(moto : Moto) : void
  +EditarMoto(placa : string, dados : Moto) : void
  +RemoverMoto(placa : string) : void
  +ConsultarProximasRevisoes() : List<AlertaRevisao>
}

class ConcessionariaService <<Service>> {
  +VincularClientePorCpf(cpf : string) : void
  +AdicionarEndereco(endereco : Endereco) : void
  +EditarEndereco(id : int, endereco : Endereco) : void
  +RemoverEndereco(id : int) : void

  +CriarChecklistTemplate(template : ChecklistTemplate) : void
  +EditarChecklistTemplate(id : int, template : ChecklistTemplate) : void
  +ExcluirChecklistTemplate(id : int) : void
}

class AgendamentoService <<Service>> {
  +ValidarAgendamento(moto : Moto, numeroRevisao : int, data : DateTime, kmAtual : int?) : bool
  +CriarRevisao(cliente : Cliente, moto : Moto, numeroRevisao : int) : Revisao

  --
  +ObterBaseTempo(moto : Moto, numeroRevisao : int) : DateTime
  +GerarAlertas(cliente : Cliente) : List<AlertaRevisao>
  +Agendar(cliente : Cliente, moto : Moto, numeroRevisao : int, concessionaria : Concessionaria, dataDesejada : DateTime, kmAtual : int?) : Revisao
  +ObterProximaRevisaoNumero(moto : Moto) : int
}

' NOVO service (responsável por “montar checklist” usando template + catálogo)
class ChecklistService <<Service>> {
  +ObterTemplatePara(modelo : ModeloMoto, numeroRevisao : int, concessionaria : Concessionaria) : ChecklistTemplate?
  +GerarItensParaRevisao(template : ChecklistTemplate, itensCatalogo : List<ItemCatalogo>) : List<RevisaoItem>
  +GerarItensParaRevisao(modelo : ModeloMoto, numeroRevisao : int, concessionaria : Concessionaria) : List<RevisaoItem>
}

' =========================
' RELACIONAMENTOS (DOMÍNIO)
' =========================
Usuario "1" -- "0..1" Cliente
Usuario "1" -- "0..1" Concessionaria

Cliente "1" o-- "0..1" Endereco
Cliente "1" o-- "*" Moto

Concessionaria "*" -- "*" Cliente
Concessionaria "1" o-- "*" Endereco
Concessionaria "1" o-- "*" ChecklistTemplate

Moto "1" o-- "*" Revisao
Revisao "1" o-- "*" RevisaoItem

ChecklistTemplate "1" o-- "*" ItemTemplate
ItemTemplate "*" --> "1" ItemCatalogo

' =========================
' DEPENDÊNCIAS (SERVIÇOS)
' =========================
ClienteService ..> Cliente
ClienteService ..> Moto
ClienteService ..> AgendamentoService
ClienteService ..> AlertaRevisao

ConcessionariaService ..> Concessionaria
ConcessionariaService ..> Cliente
ConcessionariaService ..> Endereco
ConcessionariaService ..> ChecklistTemplate

AgendamentoService ..> RegraRevisaoProvider
AgendamentoService ..> ConfiguracaoAgendamento
AgendamentoService ..> ChecklistTemplate
AgendamentoService ..> Revisao
AgendamentoService ..> Moto
AgendamentoService ..> Cliente
AgendamentoService ..> Concessionaria
AgendamentoService ..> AlertaRevisao

AuthService ..> Usuario
AuthService ..> Cliente
AuthService ..> Concessionaria

ChecklistService ..> ChecklistTemplate
ChecklistService ..> ItemCatalogoProvider
ChecklistService ..> Concessionaria
ChecklistService ..> RevisaoItem

@enduml